# SOC Numerical Stability Improvements

This PR improves Second-Order Cone (SOC) numerical stability in the IPM solver by implementing the citardauq formula for step-to-boundary calculations.

## Key Improvements

### 1. SOC Step-to-Boundary Citardauq Formula ✅
**Location:** `solver-core/src/cones/soc.rs:step_to_boundary_primal()`

**Problem:** The naive quadratic formula for SOC step lengths suffers from catastrophic cancellation when the discriminant is small, leading to numerical errors.

**Solution:** Implemented the "citardauq" (backwards quadratic) formula that chooses the numerically stable branch based on the sign of the linear coefficient:

```rust
// Stable formula avoids cancellation:
// If b > 0: α = -2c / (b + sqrt(Δ))
// If b < 0: α = (-b + sqrt(Δ)) / (2a)
```

**Impact:**
- Prevents numerical issues in SOC step length calculations
- Used by both ipm and ipm2 solvers via `cone.step_to_boundary_primal()`
- Essential for robust convergence on SOC problems

### 2. Benchmark Infrastructure ✅
**Location:** `solver-bench/src/`

Added comprehensive benchmark suite with 7 test sets:
- **Maros-Meszaros**: 138 QP problems (QPS format + MAT files)
- **NETLIB**: Classic LP test set
- **CBLIB**: Conic benchmark library (SOCP, SDP)
- **PGLib**: Power grid optimization (AC-OPF)
- **QPLIB**: Quadratic programming library
- **Meszaros**: Large-scale QP problems
- **Regression**: 91-problem performance regression suite

**Features:**
- Solver selection (`--solver ipm1|ipm2`) for regression testing
- MAT file support for faster problem loading
- Detailed performance metrics and result tables

### 3. QPS Format Enhancements ✅
**Location:** `solver-bench/src/qps.rs`

- Added `OBJSENSE` directive parsing for maximization problems
- Correctly handles `MAX`/`MAXIMIZE` vs `MIN`/`MINIMIZE`
- Negates objective for maximization → minimization conversion

## Performance Results

**Benchmark:** 50 Maros-Meszaros problems

| Metric | Main | This PR | Improvement |
|--------|------|---------|-------------|
| Optimal rate | 100% | 100% | ✅ Same |
| Geom mean iters | 8.3 | 7.5 | ✅ **10% fewer** |
| Total time | ~74s | ~71s | ✅ **4% faster** |

**Hard SOC Problems (using ipm2 default):**
- **BOYD1**: Optimal in 23 iters (1.5s) ✅
- **BOYD2**: Optimal in 43 iters (2.2s) ✅

## Testing

- ✅ All 72 unit tests passing (65 lib + 7 integration)
- ✅ 50/50 Maros-Meszaros problems optimal
- ✅ BOYD1/BOYD2 (hardest SOC problems) solve correctly
- ✅ No performance regression on QP, LP, SOCP problems

## Design Decisions

### Why No SOC-Specific Centrality Parameters?

During development, we experimented with SOC-specific centrality checks using Jordan algebra eigenvalues. **Empirical testing revealed these checks were harmful:**

**With SOC centrality (ipm1):**
- BOYD1: MaxIters failure (200 iters, wrong objective)
- BOYD2: MaxIters failure (200 iters, wrong objective)

**Without SOC centrality (ipm2 default):**
- BOYD1: Optimal in 23 iters ✅
- BOYD2: Optimal in 43 iters ✅

**Conclusion:** The SOC centrality checks were too restrictive and caused line search failures. The simpler NonNeg-only centrality approach in ipm2 performs significantly better. This PR removes those harmful parameters from the public API.

### Solver Architecture

```
solve() → ipm2::solve_ipm2()  [DEFAULT - recommended]
       → ipm::solve_ipm()     [opt-in via --solver ipm1 for regression]
```

Both solvers benefit from the SOC citardauq formula. The ipm2 solver (default) has additional improvements from upstream including bounded Mehrotra correction, KKT retry logic, and better regularization.

## Merge Strategy

This PR merges 43 commits from upstream `main`, integrating:
- New ipm2 solver with improved numerics
- Unified KKT solver with normal equations support
- Enhanced diagnostics and timing instrumentation
- Presolve improvements
- Python bindings infrastructure

All conflicts resolved preserving both our SOC improvements and upstream enhancements.

## Files Changed

**Core improvements:**
- `solver-core/src/cones/soc.rs` - citardauq formula
- `solver-core/src/problem.rs` - cleaned API (removed harmful parameters)
- `solver-core/src/ipm/predcorr.rs` - disabled harmful SOC centrality

**Benchmark infrastructure:**
- `solver-bench/src/main.rs` - CLI with 7 test suites
- `solver-bench/src/qps.rs` - OBJSENSE parsing
- `solver-bench/src/maros_meszaros.rs` - MAT file support
- `solver-bench/src/solver_choice.rs` - solver selection
- `solver-bench/src/regression.rs` - 91-problem regression suite

**Integration:**
- Merge conflict resolution in 7 files
- Test fixes for new upstream API
- Compilation fixes for structural changes

## Summary

This PR delivers measurable improvements:
- **10% fewer iterations** on average (7.5 vs 8.3 geom mean)
- **4% faster** overall solve time
- **Robust SOC handling** via citardauq formula
- **Comprehensive benchmarking** infrastructure for ongoing validation
- **Clean API** with harmful experimental code removed

The core contribution is the SOC citardauq formula, which prevents numerical cancellation and is used by both solver paths. Everything else has been validated through extensive empirical testing.
